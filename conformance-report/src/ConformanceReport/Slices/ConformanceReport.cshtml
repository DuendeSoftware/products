@using Duende.ConformanceReport.Slices
@using System.Globalization
@inherits RazorSlice<ConformanceReportResult>

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Conformance Assessment Report</title>
	<style>
		@GetStyles()
	</style>
</head>
<body>
	<div class="document">
		<!-- Document Header -->
		<header class="document-header">
			<div class="header-row">
				<div class="header-brand">
					@if (!string.IsNullOrWhiteSpace(Model.HostCompanyName) || Model.HostCompanyLogoUrl is not null)
					{
						<div class="host-company-brand">
							@if (Model.HostCompanyLogoUrl is not null)
							{
								<img src="@Model.HostCompanyLogoUrl.ToString()" alt="@(Model.HostCompanyName ?? "Company Logo")" class="host-company-logo" />
							}
							@if (!string.IsNullOrWhiteSpace(Model.HostCompanyName))
							{
								<span class="host-company-text">@Model.HostCompanyName</span>
							}
						</div>
					}
					<span class="brand-text">Duende IdentityServer</span>
				</div>
				<div class="header-meta">
					<span class="doc-id">Document ID: @GenerateDocumentId()</span>
				</div>
			</div>
			<div class="header-divider"></div>
			<h1 class="document-title">Conformance Assessment Report</h1>
			<div class="header-divider"></div>
		</header>

		<!-- Document Information -->
		<section class="document-info">
			<table class="info-table">
				<tbody>
					<tr>
						<th>License</th>
						<td>@GetLicenseInfo()</td>
					</tr>
					<tr>
						<th>Report URL</th>
						<td>@Model.Url.ToString()</td>
					</tr>
				<tr>
					<th>Assessment Date</th>
					<td>@FormatDateTime(Model.AssessedAt, includeDate: true)</td>
				</tr>
					<tr>
						<th>Tool Version</th>
						<td>@Model.Version</td>
					</tr>
					<tr>
						<th>Profiles Assessed</th>
						<td>@GetProfilesAssessed()</td>
					</tr>
				</tbody>
			</table>
		</section>

		<!-- Report Summary -->
		<section class="report-summary">
			<h2>Report Summary</h2>
			<div class="summary-box @GetStatusClass(Model.Status)">
				<div class="summary-status">
					<span class="status-label">Overall Status:</span>
					<span class="status-value">@GetStatusText(Model.Status)</span>
				</div>
				<p class="summary-description">
					This report presents the results of an automated conformance assessment of the OAuth 2.0 / OpenID Connect
					authorization server configuration. The assessment evaluates server and client configurations against
					industry security profiles and best practices.
				</p>
				<div class="summary-stats">
					<div class="stat">
						<span class="stat-value">@Model.OverallSummary.TotalClients</span>
						<span class="stat-label">Clients Assessed</span>
					</div>
					@if (Model.Profiles.OAuth21 is not null)
					{
						<div class="stat">
							<span class="stat-value">@Model.Profiles.OAuth21.Summary.PassingClients / @Model.Profiles.OAuth21.Summary.TotalClients</span>
							<span class="stat-label">OAuth 2.1 Passing</span>
						</div>
					}
					@if (Model.Profiles.Fapi2Security is not null)
					{
						<div class="stat">
							<span class="stat-value">@Model.Profiles.Fapi2Security.Summary.PassingClients / @Model.Profiles.Fapi2Security.Summary.TotalClients</span>
							<span class="stat-label">FAPI 2.0 Passing</span>
						</div>
					}
				</div>
			</div>
		</section>

		<!-- Profile Results -->
		@if (Model.Profiles.OAuth21 is not null)
		{
			@await RenderPartialAsync(_ProfileResult.Create(Model.Profiles.OAuth21))
		}
		@if (Model.Profiles.Fapi2Security is not null)
		{
			@await RenderPartialAsync(_ProfileResult.Create(Model.Profiles.Fapi2Security))
		}

		<!-- Document Footer -->
		<footer class="document-footer">
			<div class="footer-divider"></div>
			<div class="footer-content">
			<div class="footer-left">
				<p>Generated by Duende Conformance Report v<span>@Model.Version</span></p>
				<p>@FormatDateTime(Model.AssessedAt, includeDate: true)</p>
			</div>
				<div class="footer-right">
					<p>Duende Software</p>
					<p>https://duendesoftware.com</p>
				</div>
			</div>
		</footer>
	</div>
</body>
</html>

@functions {
	private static string FormatDateTime(
		DateTimeOffset timestamp,
		bool includeDate = true)
	{
		// Always display in UTC
		var format = includeDate
			? "MMMM d, yyyy HH:mm:ss"
			: "HH:mm:ss";

		return $"{timestamp.UtcDateTime.ToString(format, CultureInfo.InvariantCulture)} (UTC)";
	}

	private string GenerateDocumentId()
	{
		// Generate a reproducible document ID based on assessment timestamp in UTC
		var timestamp = Model.AssessedAt.UtcDateTime;
		return $"CR-{timestamp:yyyyMMdd}-{timestamp:HHmmss}";
	}

	private string GetProfilesAssessed()
	{
		var profiles = new List<string>();
		if (Model.Profiles.OAuth21 is not null) profiles.Add("OAuth 2.1");
		if (Model.Profiles.Fapi2Security is not null) profiles.Add("FAPI 2.0 Security Profile");
		return profiles.Count > 0 ? string.Join(", ", profiles) : "None";
	}

	private string GetLicenseInfo()
	{
		var license = Model.License;
		if (license is null || string.IsNullOrWhiteSpace(license.CompanyName))
		{
			return "No license";
		}

		var parts = new List<string>(4) { license.CompanyName };

		if (!string.IsNullOrWhiteSpace(license.Edition))
		{
			parts.Add(license.Edition);
		}

		if (license.SerialNumber.HasValue)
		{
			parts.Add($"#{license.SerialNumber.Value.ToString(CultureInfo.InvariantCulture)}");
		}

		if (license.Expiration.HasValue)
		{
			parts.Add($"Expires {license.Expiration.Value.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)}");
		}

		return string.Join(" | ", parts);
	}

	private string GetStatusClass(ConformanceReportStatus status) => status switch
	{
		ConformanceReportStatus.Pass => "status-pass",
		ConformanceReportStatus.Warn => "status-warn",
		ConformanceReportStatus.Fail => "status-fail",
		_ => "status-unknown"
	};

	private string GetStatusText(ConformanceReportStatus status) => status switch
	{
		ConformanceReportStatus.Pass => "CONFORMANT",
		ConformanceReportStatus.Warn => "CONFORMANT WITH WARNINGS",
		ConformanceReportStatus.Fail => "NON-CONFORMANT",
		_ => "UNKNOWN"
	};

	private IHtmlContent GetStyles() => new HtmlString("""
	:root {
		--color-pass: #166534;
		--color-pass-bg: #f0fdf4;
		--color-pass-border: #86efac;
		--color-warn: #854d0e;
		--color-warn-bg: #fefce8;
		--color-warn-border: #fde047;
		--color-fail: #991b1b;
		--color-fail-bg: #fef2f2;
		--color-fail-border: #fca5a5;
		--color-na: #6b7280;
		--color-text: #111827;
		--color-text-muted: #4b5563;
		--color-border: #d1d5db;
		--color-border-dark: #9ca3af;
		--color-bg-header: #f9fafb;
		--color-brand: #6e45af;
	}

	* {
		box-sizing: border-box;
		margin: 0;
		padding: 0;
	}

	body {
		font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
		font-size: 11pt;
		line-height: 1.5;
		color: var(--color-text);
		background: #fff;
	}

	.document {
		max-width: 1100px;
		margin: 0 auto;
		padding: 2rem;
	}

	/* Document Header */
	.document-header {
		margin-bottom: 2rem;
	}

	.header-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1rem;
	}

	.header-brand {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.host-company-brand {
		display: flex;
		align-items: center;
		gap: 0.75rem;
	}

	.host-company-logo {
		max-height: 40px;
		max-width: 200px;
		object-fit: contain;
	}

	.host-company-text {
		font-size: 12pt;
		font-weight: 600;
		color: var(--color-text);
		letter-spacing: 0.03em;
	}

	.brand-text {
		font-variant-caps: small-caps;
		font-size: 14pt;
		font-weight: 700;
		color: var(--color-brand);
		letter-spacing: 0.05em;
	}

	.doc-id {
		font-size: 10pt;
		color: var(--color-text-muted);
		font-family: 'Consolas', 'Courier New', monospace;
	}

	.header-divider {
		height: 2px;
		background: var(--color-border-dark);
		margin: 0.5rem 0;
	}

	.document-title {
		font-variant-caps: small-caps;
		font-size: 20pt;
		font-weight: 600;
		text-align: center;
		padding: 1rem 0;
		color: var(--color-text);
	}

	/* Document Info Table */
	.document-info {
		margin-bottom: 2rem;
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.info-table {
		width: 100%;
		border-collapse: collapse;
		font-size: 10pt;
	}

	.info-table th,
	.info-table td {
		padding: 0.5rem 1rem;
		text-align: left;
		border: 1px solid var(--color-border);
	}

	.info-table th {
		width: 180px;
		background: var(--color-bg-header);
		font-weight: 600;
		color: var(--color-text);
	}

	.info-table td {
		font-family: 'Consolas', 'Courier New', monospace;
	}

	/* Report Summary */
	.report-summary {
		margin-bottom: 2rem;
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.report-summary h2 {
		font-size: 14pt;
		font-weight: 600;
		margin-bottom: 1rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid var(--color-border-dark);
	}

	.summary-box {
		padding: 1.5rem;
		border: 2px solid;
	}

	.summary-box.status-pass {
		border-color: var(--color-pass-border);
		background: var(--color-pass-bg);
	}

	.summary-box.status-warn {
		border-color: var(--color-warn-border);
		background: var(--color-warn-bg);
	}

	.summary-box.status-fail {
		border-color: var(--color-fail-border);
		background: var(--color-fail-bg);
	}

	.summary-status {
		margin-bottom: 1rem;
	}

	.status-label {
		font-weight: 600;
		margin-right: 0.5rem;
	}

	.status-value {
		font-weight: 700;
		font-size: 12pt;
	}

	.status-pass .status-value {
		color: var(--color-pass);
	}

	.status-warn .status-value {
		color: var(--color-warn);
	}

	.status-fail .status-value {
		color: var(--color-fail);
	}

	.summary-description {
		margin-bottom: 1rem;
		color: var(--color-text-muted);
		font-size: 10pt;
	}

	.summary-stats {
		display: flex;
		gap: 2rem;
		padding-top: 1rem;
		border-top: 1px solid var(--color-border);
	}

	.stat {
		display: flex;
		flex-direction: column;
	}

	.stat-value {
		font-size: 14pt;
		font-weight: 700;
		color: var(--color-text);
	}

	.stat-label {
		font-size: 9pt;
		color: var(--color-text-muted);
		text-transform: uppercase;
		letter-spacing: 0.03em;
	}

	/* Section Headers */
	h2 {
		font-size: 14pt;
		font-weight: 600;
		margin: 2rem 0 1rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid var(--color-border-dark);
	}

	h3 {
		font-size: 11pt;
		font-weight: 600;
		margin: 1.5rem 0 0.75rem;
		color: var(--color-text);
	}

	/* Profile Section */
	.profile-section {
		margin-bottom: 2rem;
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.profile-header {
		display: flex;
		justify-content: space-between;
		align-items: baseline;
		margin-bottom: 0.5rem;
	}

	.profile-title {
		font-size: 14pt;
		font-weight: 600;
		margin: 0;
		padding: 0;
		border: none;
	}

	.profile-status {
		font-weight: 700;
		font-size: 10pt;
		padding: 0.25rem 0.75rem;
		border: 1px solid;
	}

	.profile-status.status-pass {
		color: var(--color-pass);
		border-color: var(--color-pass);
		background: var(--color-pass-bg);
	}

	.profile-status.status-warn {
		color: var(--color-warn);
		border-color: var(--color-warn);
		background: var(--color-warn-bg);
	}

	.profile-status.status-fail {
		color: var(--color-fail);
		border-color: var(--color-fail);
		background: var(--color-fail-bg);
	}

	.profile-meta {
		font-size: 9pt;
		color: var(--color-text-muted);
		margin-bottom: 1rem;
	}

	.profile-note {
		font-size: 9pt;
		color: var(--color-text-muted);
		font-style: italic;
		margin-bottom: 1rem;
		padding: 0.5rem;
		background: var(--color-bg-header);
		border-left: 3px solid var(--color-border-dark);
	}

	/* Assessment Tables */
	.assessment-table {
		width: 100%;
		border-collapse: collapse;
		font-size: 10pt;
		margin-bottom: 1.5rem;
		page-break-inside: auto;
		break-inside: auto;
	}

	.assessment-table th,
	.assessment-table td {
		padding: 0.5rem 0.75rem;
		text-align: left;
		border: 1px solid var(--color-border);
	}

	.assessment-table tr {
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.assessment-table thead {
		display: table-header-group;
	}

	.assessment-table tbody {
		display: table-row-group;
	}

	.assessment-table thead th {
		background: var(--color-bg-header);
		font-weight: 600;
		font-size: 9pt;
		text-transform: uppercase;
		letter-spacing: 0.03em;
	}

	.assessment-table .col-rule {
		width: 60px;
		font-family: 'Consolas', 'Courier New', monospace;
		font-weight: 600;
	}

	.assessment-table .col-status {
		width: 80px;
		text-align: center;
		font-weight: 600;
	}

	.assessment-table .col-status.pass {
		color: var(--color-pass);
	}

	.assessment-table .col-status.warn {
		color: var(--color-warn);
	}

	.assessment-table .col-status.fail {
		color: var(--color-fail);
	}

	.assessment-table .col-status.na {
		color: var(--color-na);
	}

	/* Matrix Table */
	.matrix-section {
		margin-bottom: 1.5rem;
		overflow-x: auto;
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.matrix-table {
		width: 100%;
		border-collapse: collapse;
		font-size: 9pt;
		page-break-inside: auto;
		break-inside: auto;
	}

	.matrix-table th,
	.matrix-table td {
		padding: 0.5rem;
		border: 1px solid var(--color-border);
		text-align: center;
	}

	.matrix-table tr {
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.matrix-table thead {
		display: table-header-group;
	}

	.matrix-table tbody {
		display: table-row-group;
	}

	.matrix-table thead th {
		background: var(--color-bg-header);
		font-weight: 600;
		font-size: 8pt;
	}

	.matrix-table .entity-col {
		text-align: left;
		min-width: 180px;
		font-weight: 500;
	}

	.matrix-table .entity-id {
		display: block;
		font-size: 8pt;
		font-family: 'Consolas', 'Courier New', monospace;
		color: var(--color-text-muted);
		font-weight: 400;
	}

	.matrix-table .cell-pass {
		color: var(--color-pass);
		font-weight: 600;
	}

	.matrix-table .cell-warn {
		color: var(--color-warn);
		font-weight: 600;
	}

	.matrix-table .cell-fail {
		color: var(--color-fail);
		font-weight: 600;
	}

	.matrix-table .cell-na {
		color: var(--color-na);
	}

	.matrix-table .status-col {
		font-weight: 700;
		min-width: 70px;
	}

	.matrix-table .ref-link {
		font-size: 7pt;
		color: var(--color-brand);
		vertical-align: super;
		text-decoration: none;
	}

	/* Rule Legend */
	.rule-legend {
		margin-bottom: 1.5rem;
		padding: 1rem;
		background: var(--color-bg-header);
		border: 1px solid var(--color-border);
		font-size: 9pt;
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.rule-legend h4 {
		font-size: 10pt;
		font-weight: 600;
		margin-bottom: 0.75rem;
	}

	.legend-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
		gap: 0.25rem 1.5rem;
	}

	.legend-item {
		display: flex;
		gap: 0.5rem;
		padding: 0.2rem 0;
	}

	.legend-code {
		font-family: 'Consolas', 'Courier New', monospace;
		font-weight: 600;
		min-width: 45px;
		flex-shrink: 0;
	}

	.legend-text {
		color: var(--color-text-muted);
	}

	/* Findings Section */
	.findings-section {
		margin-bottom: 1.5rem;
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.findings-section h4 {
		font-size: 11pt;
		font-weight: 600;
		margin-bottom: 0.75rem;
	}

	.finding-group {
		margin-bottom: 1rem;
		padding: 1rem;
		border: 1px solid var(--color-border);
		background: #fff;
		page-break-inside: avoid;
		break-inside: avoid;
	}

	.finding-group-header {
		font-weight: 600;
		margin-bottom: 0.5rem;
		padding-bottom: 0.5rem;
		border-bottom: 1px solid var(--color-border);
	}

	.finding-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.finding-item {
		padding: 0.5rem 0;
		border-bottom: 1px solid var(--color-border);
		font-size: 10pt;
	}

	.finding-item:last-child {
		border-bottom: none;
	}

	.finding-number {
		font-family: 'Consolas', 'Courier New', monospace;
		font-weight: 600;
		color: var(--color-text-muted);
		margin-right: 0.5rem;
	}

	.finding-action {
		font-weight: 600;
	}

	.finding-detail {
		display: block;
		margin-left: 1.75rem;
		color: var(--color-text-muted);
		font-size: 9pt;
	}

	/* Document Footer */
	.document-footer {
		margin-top: 3rem;
	}

	.footer-divider {
		height: 2px;
		background: var(--color-border-dark);
		margin-bottom: 1rem;
	}

	.footer-content {
		display: flex;
		justify-content: space-between;
		font-size: 9pt;
		color: var(--color-text-muted);
	}

	.footer-left p,
	.footer-right p {
		margin: 0.15rem 0;
	}

	.footer-right {
		text-align: right;
	}

	/* Print Styles */
	@media print {
		body {
			font-size: 10pt;
			background: #fff;
		}

		.document {
			max-width: none;
			padding: 0;
			margin: 0;
		}

		.profile-section {
			page-break-inside: avoid;
		}

		.assessment-table,
		.matrix-table {
			page-break-inside: auto;
		}

		.assessment-table tr,
		.matrix-table tr {
			page-break-inside: avoid;
		}

		.findings-section {
			page-break-before: auto;
		}

		.document-footer {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			padding: 0.5rem 2rem;
			background: #fff;
		}

		a {
			color: inherit;
			text-decoration: none;
		}

		a[href]::after {
			content: none;
		}
	}

	@media (max-width: 768px) {
		.document {
			padding: 1rem;
		}

		.header-row {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}

		.summary-stats {
			flex-wrap: wrap;
		}

		.legend-grid {
			grid-template-columns: 1fr;
		}

		.matrix-table {
			font-size: 8pt;
		}

		.footer-content {
			flex-direction: column;
			gap: 0.5rem;
		}

		.footer-right {
			text-align: left;
		}
	}
	""");
}
